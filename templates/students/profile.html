{% extends 'base.html' %}
{% block title %}My Profile{% endblock %}
{% block content %}
<h2 class="mb-3"><i class="bi bi-person-circle text-primary"></i> My Profile</h2>
<div class="card shadow-sm">
  <div class="card-body">
    <form id="profileForm">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Student ID</label>
          <div class="form-control-plaintext" id="student_id_text">â€”</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">First name</label>
          <input class="form-control" id="first_name" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Last name</label>
          <input class="form-control" id="last_name" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input class="form-control" id="email" type="email" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Phone</label>
          <input class="form-control" id="phone" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Course</label>
          <input class="form-control" id="course" />
        </div>
        <div class="col-12">
          <label class="form-label">Address</label>
          <textarea class="form-control" id="address"></textarea>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" type="submit">Save</button>
        <button class="btn btn-outline-secondary" type="button" id="loadBtn">Reload</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  function getCookie(name) { const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
  const csrftoken = getCookie('csrftoken');
  async function load() {
    const res = await fetch('/students/profiles/');
    const json = await res.json();
    const p = (json.items||[])[0];
    if (!p) return;
    const idText = document.getElementById('student_id_text');
    if (idText && p.student_id) idText.textContent = p.student_id;
    ['first_name','last_name','email','phone','course','address'].forEach(k=>{
      const el = document.getElementById(k); if (el && p[k]!==undefined) el.value = p[k] || '';
    });
  }
  document.getElementById('loadBtn').addEventListener('click', load);
  document.getElementById('profileForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const body = {
      first_name: document.getElementById('first_name').value,
      last_name: document.getElementById('last_name').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      address: document.getElementById('address').value,
      course: document.getElementById('course').value
    };
    const res = await fetch('/students/profiles/', { method:'POST', headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify(body)});
    if (res.ok) { alert('Saved'); load(); } else { alert('Failed to save'); }
  });
  load();
})();
</script>
{% endblock %}
